#!/bin/bash

UNIT_DIR="$2"
REMOTE_FS=(afs cifs smbfs sshfs ncpfs ncp nfs nfs4 gfs gfs2 glusterfs)
export HOSTNAME=$(cat /proc/sys/kernel/hostname)

set -- $(cat /proc/cmdline)
for x in "$@"; do
    case "$x" in
        mount.usr=*)
            arg="${x#mount.usr=}"
            export NFSSERVER="${arg%%:/*}"
            ;;
    esac
done

while read l; do
    [[ "$l" =~ ^\# ]] && continue

    l=$(echo $l | tr -s [:blank:])
    what=$(echo $l | cut -d' ' -f1 | envsubst)
    where=$(echo $l | cut -d' ' -f2)
    fstype=$(echo $l | cut -d' ' -f3)
    options=$(echo $l | cut -d' ' -f4)
    filename=$(echo $where | cut -d/ -f 2- --output-delimiter=-).mount

    cat << EOF > ${UNIT_DIR}/${filename}
# Automatically generated by local-fstab-generator
[Unit]
SourcePath=/usr/local/etc/fstab

[Mount]
What=${what}
Where=${where}
EOF

    if [ "x${fstype}" != "x" ] && \
       [ "x${fstype}" != "x-" ] && \
       [ "x${fstype}" != "xauto" ]
    then
        echo "Type=${fstype}" >> ${UNIT_DIR}/${filename}
    fi

    if [ "x${options}" != "x" ] && \
       [ "x${options}" != "x-" ] && \
       [ "x${options}" != "xdefaults" ]
    then
        echo "Options=${options}" >> ${UNIT_DIR}/${filename}
    fi

    remote_fs=$(echo ${REMOTE_FS[@]//${fstype}/})
    if [ "${REMOTE_FS[*]}" == "${remote_fs[*]}" ]; then
        post='local-fs.target'
    else
        post='remote-fs.target'
    fi

    mkdir -p "${UNIT_DIR}/${post}.requires/"
    ln -s -r "${UNIT_DIR}/${filename}" "${UNIT_DIR}/${post}.requires/${filename}"

done < /usr/local/etc/fstab
